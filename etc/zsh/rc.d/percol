_command_exists percol || return

function percol_select_history()
{
    BUFFER=$(fc -l -n 1 | tac | percol --query "$LBUFFER")
    CURSOR=$#BUFFER         # move cursor
    zle -R -c               # refresh
}

zle -N percol_select_history
bindkey '^R' percol_select_history
